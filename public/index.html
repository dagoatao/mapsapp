<!DOCTYPE html>
<html ng-app="recat">
  <head>
    <title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.0.0.min.js" integrity="sha256-JmvOoLtYsmqlsWxa7mDSLMwa6dZ9rrIdtrrVYRnDRH0=" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js" integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw=" crossorigin="anonymous"></script>
  <!--<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/south-street/jquery-ui.css"/>-->
  <link rel="stylesheet" href="style.css"/>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.0/spectrum.min.css">
  <link rel="stylesheet" href="css/leaflet-sidebar.css" />
  </head>
  <body>
    <div id="titlebar">
      <span id="title">Maps</span>
    </div>

    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
                <li class="disabled"><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <div id="tools">
                  <div class='tool1'>
                    <button id="plyadd" value=0><img src="images/icons/polygon.png" style="width:20px;height:20px;"/></button> <span class='space'>|</span>
                  </div>
                  <div class='tool2'>
                    <button id="lineadd" value=0><img src="images/icons/communication.png" style="width:20px;height:20px;"/></button> <span class='space'> | </span>
                  </div>
                  <div class='tool3'>
                    <button id="mrkadd" value=0><img src="images/icons/add-pointer.png" style="width:20px;height:20px;"/></button> : <span id="markers"></span>
                  </div>
                </div>
              </div>
            </div>

            <div class="sidebar-pane" id="profile">
                <h1 class="sidebar-header">Profile<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>

            <div class="sidebar-pane" id="messages">
                <h1 class="sidebar-header">Messages<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>
        </div>
    </div>
    <div id="mapid" style="width: 100%; height: 600px; position:aboslute;"></div>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="js/leaflet-sidebar.js"></script>
    <script>
      var mymap = L.map('mapid').setView([40.33346, -75.93922], 13);
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
          '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
      }).addTo(mymap);
      var sidebar = L.control.sidebar('sidebar').addTo(mymap);

      L.marker([40.33346, -75.93922]).addTo(mymap)
        .bindPopup("<b>Starting Point</b>").openPopup();
      L.circle([40.33346, -75.93922], 100, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5
      }).addTo(mymap).bindPopup("I am a circle.");

      var area;
      // = L.polygon([
      //   [40.30544, -75.97518],
      //   [40.33509, -75.95844],
      //   [40.33489, -75.93956],
      //   [40.3057, -75.89802]
      // ]).addTo(mymap).bindPopup("I am a polygon.");

      function iconForImage(path) {
        return L.icon({
          iconUrl: path,
          iconSize:     [38, 38], // size of the icon
          shadowSize:   [50, 64], // size of the shadow
          iconAnchor:   [20, 40], // point of the icon which will correspond to marker's location
          shadowAnchor: [4, 62],  // the same for the shadow
          popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
        });
    }

      var popup = L.popup()
      //var comment = document.querySelector("#f");
      var customMarker = 0;
      var iconImagePath = null;
      var currentColor=null;

      function plySave(layer) {
        if (mymap.hasLayer(layer)) {
          var shape = layer.toGeoJSON()
          var shape_for_db = JSON.stringify(shape);
          //document.querySelector("#f").innerHTML = shape_for_db;
        } else {
          //document.querySelector("#f").innerHTML = "no polygon";
        }
      }

      function onPlyClear(e) {
        mymap.removeLayer(area);
      }

      function onMarkerPopupOpen() {
         var temp = this;
         // To remove marker on click of delete button in the popup of marker
         $(".delete-marker:visible").click(function () {
          mymap.removeLayer(temp);
         });
         $(".flip-marker:visible").click(function() {

         });
      }
      function onPolygonPopupOpen() {
         var temp = this;
         // To remove marker on click of delete button in the popup of marker
         $(".delete-polygon:visible").click(function () {
           mymap.removeLayer(temp);
         });
         $(".color-polygon:visible").click(function() {
           temp.setStyle({
             color:"black"
           });
         });
         $(".hide:visible").click(function() {

         });
         $(".colorpicker:visible").spectrum({
            color: "#f00",
            change: function(color) {
                currentColor=color.toHexString();
                temp.setStyle({
                  color:currentColor
                });
            }
          });
          $(".opacityselect:visible").change(function() {
            temp.setStyle({
              opacity:$(".opacityselect:visible").val(),
              fillOpacity:$(".opacityselect:visible").val()-0.2
            })
          });

      }
      function onLinePopupOpen() {
        var temp = this;
        // To remove marker on click of delete button in the popup of marker
        $(".delete-line:visible").click(function () {
         mymap.removeLayer(temp);
        });
        $(".colorpicker:visible").spectrum({
           color: "#f00",
           change: function(color) {
               currentColor=color.toHexString();
               temp.setStyle({
                 color:currentColor
               });
           }
         });
         $(".opacityselect:visible").change(function() {
           temp.setStyle({
             opacity:$(".opacityselect:visible").val()
           })
         });
      }

      var currentPolygon=null;
      var currentLine=null;
      function onMapClick(e) {
        if (document.querySelector('#plyadd').value == 1) {
          if (currentPolygon) {
            currentPolygon.addLatLng(e.latlng);
          } else {
            var p = L.polygon(e.latlng).bindPopup(
              "<span>Color:</span>"+
              "<input type='button' class='colorpicker' value='Color'/></br>"+
              "<span>Opacity:</span>"+
              "<div class='opacityslider'>"+
                "<select class=opacityselect>" +
                  "<option value=0.0>0.0</option>"+
                  "<option value=0.1>0.1</option>"+
                  "<option value=0.2>0.2</option>"+
                  "<option value=0.3>0.3</option>"+
                  "<option value=0.4>0.4</option>"+
                  "<option value=0.5>0.5</option>"+
                "   <option value=0.6>0.6</option>"+
                "   <option value=0.7>0.7</option>"+
                "   <option value=0.8>0.8</option>"+
                "   <option value=0.9>0.9</option>"+
                "   <option value=1.0>1.0</option>"+
                "</select>"+
              "</div>"+
              "<input type='button' value='Delete' class='delete-polygon'/>"
            );
            p.on("popupopen", onPolygonPopupOpen);
            mymap.addLayer(p);
            currentPolygon=p;
          }
        } else if (document.querySelector('#lineadd').value==1) {
          if ( currentLine) {
            currentLine.addLatLng(e.latlng);
          } else {
            var line = L.polyline([e.latlng], {color: 'green'}).addTo(mymap).bindPopup(
              "<input type='button' class='colorpicker' value='Color'/></br>"+
              "<input type='button' value='Delete' class='delete-polygon'/>"
            )
            .on("popupopen", onLinePopupOpen);
            currentLine = line;
          }
        } else if (document.querySelector('#mrkadd').value==1) {
          tmp = null;
          if (iconImagePath)
            tmp = L.marker(e.latlng, {icon:iconForImage(iconImagePath)}).bindPopup("<input type='button' value='Delete' class='delete-marker'/>  <input type='button' value='Flip' class='flip-marker'/>");
          else
            tmp = L.marker(e.latlng).bindPopup("<input type='button' value='Delete' class='delete-marker'/>");
          tmp.on("popupopen", onMarkerPopupOpen);
          tmp.addTo(mymap);
        } else {
          p = L.popup()
            .setLatLng(e.latlng)
            .setContent("You clicked the map at "+ e.latlng);
            mymap.openPopup(p);
        }

      }
      mymap.on('click', onMapClick);

      $(document).ready(function() {
        //$("#markers").append("this there");
      // if ($("#mrkadd").val()==0) $("#markers").hide();

        $('#plyadd').bind({
          click: function() {
            e = $(this);
            e.val( (e.val()==1) ? 0 : 1 );
            e.css("background-color", ( (e.val()==1) ? "blue" : "white" ));
            if (e.val()==0) currentPolygon=null;
          }
        });

        $('#lineadd').bind({
          click: function() {
            e = $(this);
            e.val( (e.val()==1) ? 0 : 1 );
            e.css("background-color", ( (e.val()==1) ? "blue" : "white" ));
            if (e.val()==0) currentLine=null;
          }
        });

        $("body").on('click','.custom-marker', function() {
            $('.custom-marker').css("background-color", "white");
            e = $(this);
            e.val( (e.val()==1) ? 0 : 1 );
            e.css("background-color", ( (e.val()==1) ? "blue" : "white" ));
            iconImagePath = (e.val()==1) ? e.children().first().attr('src') : null;
            $("#markers").append(iconImagePath);
        });

        $('#plysave').bind({
          click: function() {
            plySave(area);
          }
        });


        $('#mrkadd').bind({
          click: function() {
            if ($(this).val() == 1) {
              $(this).val(0);
              $(this).css("background-color", "white");
              //$("#markers").hide();
              //$("#f").html(" ");
            } else {
              $(this).val(1);
              $(this).css("background-color", "blue");
              // $("#markers").show();
              //$('#f').html("<input type='text' title='marker' value=''/><button id='whatisit'>Save</button>");
            }
          }
        });

        //$("button img").button();
        $.getJSON( "/api/markers", function( data ) {
           var items = [];
           var count = 0;
           $.each( data, function( index, val ) {
             //$("#markers").append(index);
             //if ( index > 15) return;
             $("#markers").append('<button id="ico'+index+'" class="custom-marker" value=0><img src="images/markers/'+val+'" style="width:23px;height:23px;"/></button>');
           });
         });

      });




      </script>
  </body>
  </html>
